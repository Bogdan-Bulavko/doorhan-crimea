// Prisma schema for DoorHan Crimea admin

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  customer
  admin
  manager
}

enum OrderStatus {
  pending
  confirmed
  processing
  shipped
  delivered
  cancelled
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String?
  role         UserRole   @default(customer)
  isActive     Boolean    @default(true)
  avatarUrl    String?
  preferences  Json?
  orders       Order[]
  adminLogs    AdminLog[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Category {
  id                Int                  @id @default(autoincrement())
  name              String
  description       String?
  imageUrl          String?
  iconName          String?
  color             String?
  hoverColor        String?
  slug              String               @unique
  parentId          Int?
  parent            Category?            @relation("CategoryChildren", fields: [parentId], references: [id])
  children          Category[]           @relation("CategoryChildren")
  isActive          Boolean              @default(true)
  sortOrder         Int                  @default(0)
  seoTitle          String?
  seoDescription    String?
  canonicalUrl      String?
  h1                String?
  robotsMeta        String?              @default("index, follow")
  schemaMarkup      String?
  contentTop        String? // HTML контент для отображения вверху страницы категории (с поддержкой шорткодов)
  contentBottom     String? // HTML контент для отображения внизу страницы категории (с поддержкой шорткодов)
  products          Product[]            @relation("ProductMainCategory")
  productCategories ProductCategory[] // Many-to-many связь с товарами
  regionalData      CategoryRegionData[] // Региональные данные для категории
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
}

// Региональные данные для категорий (уникализация под города)
model CategoryRegionData {
  id             Int      @id @default(autoincrement())
  categoryId     Int
  category       Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  regionCode     String // Код региона (например: 'simferopol', 'kerch', 'default')
  description    String? // Описание для региона
  h1             String? // H1 заголовок для региона
  seoTitle       String? // Метатег title для региона
  seoDescription String? // Метатег description для региона
  schemaMarkup   String? // Schema Markup (JSON-LD) для региона
  contentTop     String? // HTML контент сверху страницы для региона
  contentBottom  String? // HTML контент снизу страницы для региона
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([categoryId, regionCode])
  @@index([categoryId])
  @@index([regionCode])
}

// Many-to-many связь между Product и Category
model ProductCategory {
  id         Int      @id @default(autoincrement())
  productId  Int
  categoryId Int
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  isPrimary  Boolean  @default(false) // Основная категория для товара
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

model Product {
  id               Int                    @id @default(autoincrement())
  name             String
  title            String?
  description      String?
  shortDescription String?
  mainImageUrl     String?
  categoryId       Int // Основная категория (для обратной совместимости)
  category         Category               @relation("ProductMainCategory", fields: [categoryId], references: [id])
  categories       ProductCategory[] // Many-to-many связь с категориями
  slug             String                 @unique
  sku              String?                @unique
  price            Decimal
  minPrice         Decimal? // Минимальная цена "от XXXX"
  oldPrice         Decimal?
  currency         String                 @default("RUB")
  inStock          Boolean                @default(true)
  stockQuantity    Int                    @default(0)
  isNew            Boolean                @default(false)
  isPopular        Boolean                @default(false)
  isFeatured       Boolean                @default(false)
  rating           Decimal                @default(0)
  reviewsCount     Int                    @default(0)
  seoTitle         String?
  seoDescription   String?
  canonicalUrl     String? // Canonical URL для товара (один основной URL)
  h1               String?
  robotsMeta       String?                @default("index, follow")
  schemaMarkup     String?
  specifications   ProductSpecification[]
  colors           ProductColor[]
  images           ProductImage[]
  orderItems       OrderItem[]
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  imageUrl  String
  altText   String?
  sortOrder Int      @default(0)
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProductSpecification {
  id        Int      @id @default(autoincrement())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String
  value     String
  unit      String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
}

model ProductColor {
  id        Int      @id @default(autoincrement())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String
  value     String
  hexColor  String
  imageUrl  String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
}

model Order {
  id              Int           @id @default(autoincrement())
  orderNumber     String        @unique
  userId          Int?
  user            User?         @relation(fields: [userId], references: [id])
  customerInfo    Json
  status          OrderStatus   @default(pending)
  paymentStatus   PaymentStatus @default(pending)
  shippingAddress Json
  billingAddress  Json?
  subtotal        Decimal
  shippingCost    Decimal       @default(0)
  tax             Decimal       @default(0)
  discount        Decimal       @default(0)
  total           Decimal
  currency        String        @default("RUB")
  notes           String?
  items           OrderItem[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model OrderItem {
  id              Int      @id @default(autoincrement())
  orderId         Int
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       Int?
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  quantity        Int
  price           Decimal
  totalPrice      Decimal
  selectedColor   String?
  selectedOptions Json?
  createdAt       DateTime @default(now())
}

model ContactForm {
  id         Int      @id @default(autoincrement())
  name       String
  email      String
  phone      String?
  company    String?
  subject    String
  message    String
  status     String   @default("new")
  adminNotes String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CallbackRequest {
  id            Int      @id @default(autoincrement())
  name          String
  phone         String
  preferredTime String?
  message       String?
  status        String   @default("new")
  adminNotes    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SiteSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String?
  type        String   @default("string")
  description String?
  updatedAt   DateTime @updatedAt
}

model AdminLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  tableName String?
  recordId  Int?
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Region {
  id                      Int      @id @default(autoincrement())
  code                    String   @unique
  name                    String
  phone                   String
  phoneFormatted          String
  email                   String
  address                 String
  addressDescription      String?
  workingHours            String
  workingHoursDescription String?
  mapIframe               String?
  officeName              String?
  schemaMarkup            String? // JSON-LD микроразметка для главной страницы региона
  homeContent             String? // Региональный контент для главной страницы (с поддержкой шорткодов)
  isActive                Boolean  @default(true)
  sortOrder               Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

model Page {
  id             Int      @id @default(autoincrement())
  title          String
  slug           String   @unique
  content        String
  seoTitle       String?
  seoDescription String?
  canonicalUrl   String?
  h1             String?
  robotsMeta     String?  @default("index, follow")
  schemaMarkup   String?
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Menu {
  id          Int        @id @default(autoincrement())
  name        String     @unique // 'header' или 'footer'
  description String?
  items       MenuItem[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model MenuItem {
  id        Int        @id @default(autoincrement())
  menuId    Int
  menu      Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  title     String // Название пункта меню
  href      String // URL или якорь
  parentId  Int? // Для вложенных меню (секции в футере)
  parent    MenuItem?  @relation("MenuItemChildren", fields: [parentId], references: [id])
  children  MenuItem[] @relation("MenuItemChildren")
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  target    String?    @default("_self") // _self, _blank, _parent, _top
  icon      String? // Название иконки (опционально)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Article {
  id               Int       @id @default(autoincrement())
  title            String
  slug             String    @unique
  content          String
  excerpt          String? // Краткое описание статьи
  featuredImageUrl String? // Изображение статьи
  author           String? // Автор статьи
  tags             String? // Теги через запятую или JSON
  seoTitle         String?
  seoDescription   String?
  canonicalUrl     String?
  h1               String?
  robotsMeta       String?   @default("index, follow")
  schemaMarkup     String?
  isActive         Boolean   @default(true)
  sortOrder        Int       @default(0)
  publishedAt      DateTime? // Дата публикации
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}
